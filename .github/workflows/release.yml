name: Release

on:
    push:
        tags:
            - "*"
        branches:
            - "+([0-9])?(.{+([0-9]),x}).x"
            - master
            - beta
            - alpha
    pull_request:
        branches:
            - "+([0-9])?(.{+([0-9]),x}).x"
            - master
            - beta
            - alpha

jobs:
    build:
        runs-on: ubuntu-latest
        container: node:alpine
        steps:
            - run: apk update && apk add --no-cache tar
            - uses: actions/checkout@v2
            - uses: actions/cache@v2
              with:
                  path: node_modules/
                  key: ${{ hashFiles('deps.txt') }}
            - uses: actions/cache@v2
              with:
                  path: dist/
                  key: ${{ github.sha }}

            - run: mkdir -p dist
            - run: echo app > dist/out

    test:
        needs: build
        runs-on: ubuntu-latest
        container: node:alpine
        steps:
            - run: apk update && apk add --no-cache tar
            - uses: actions/checkout@v2
            - uses: actions/cache@v2
              with:
                  path: node_modules/
                  key: ${{ hashFiles('deps.txt') }}

            - run: echo Test

    release:
        needs: test
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - uses: actions/cache@v2
              with:
                  path: dist/
                  key: ${{ github.sha }}
            - run: |
                  echo .git > .dockerignore
                  if [ ${{ github.tag }} ]; then
                    export CI_TAG=${{ github.tag }}
                    export CI_CHANNEL=$(git branch --contains ${{ github.tag }} --format='%(refname:short)')
                    if [ $CI_CHANNEL = master ]; then
                        export CI_CHANNEL=latest
                    elif [ $CI_CHANNEL = beta ]; then
                        export CI_CHANNEL=beta
                    elif [ $CI_CHANNEL = alpha ]; then
                        export CI_CHANNEL=alpha
                    else
                        export CI_CHANNEL=${{ github.tag }}
                    fi
                  else
                    export CI_TAG=${{ github.sha }}
                    export CI_CHANNEL=${{ github.sha }}
                  fi

            - uses: docker/login-action@v1
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}
            - uses: docker/build-push-action@v2
              with:
                  push: true
                  file: .github/Dockerfile
                  tags: ghcr.io/${{ github.repository }}:$CI_TAG,ghcr.io/${{ github.repository }}:$CI_CHANNEL

    deploy:
        needs: release
        runs-on: ubuntu-latest
        container: hashicorp/terraform
        services:
            docker:
                image: docker:dind
                options: --tls=false
        env:
            CI_COMMIT_TAG: ${CI_COMMIT_TAG:-${CI_MERGE_REQUEST_ID:-"latest"}}
            CI_MERGE_REQUEST_ID: ${{ github.event.pull_request.number }}
        steps:
            - uses: actions/checkout@v2
            - uses: hashicorp/setup-terraform@v1
            - run: |
                  cp .gitlab/terraform.tf .
                  if [ ${{ github.tag }} ]; then
                    export CI_TAG=latest
                  else
                    export CI_TAG=${{ github.sha }}
                  fi

            - run: terraform init
            - run: terraform apply -auto-approve
